***************
*** 159,196 ****
  }
  
  /**
-  * Initialize the JavaScript on the page
   */
  function _bunchball_nitro_initialize() {
-   $nitro_js_url = "http://assets.bunchball.net/scripts/nitro/current/nitro.js";
  
-   // if the nitro_js_url is already in the SESSION variable, then this
-   // has already run..
    $current_js_array = drupal_add_js();
    if (isset ($current_js_array[$nitro_js_url])) {
      return;
    }
  
-   // will get the API key from server side
    $api_key = variable_get('bunchball_apikey', '');
- 
    if ($api_key == '') {
      watchdog('bunchball_nitro', 'API Key not set', array());
      return;
    }
  
-   global $user;
- 
-   // detect whether the environment is production or debug (sandbox)
    $environment = variable_get('bunchball_environment', 'sandbox');
-   if (strlen($environment) == 0) {
-     $endpoint_url = 'sandbox';
-   }
- 
-   // change this so that debug mode is reflected in the environment.
    $in_debug_mode = ($environment == 'sandbox');
  
-   // parse domain from the variables
    $endpoint_url = variable_get('bunchball_production_url', 'http://sandbox.bunchball.net/nitro/json');
    if (strlen($endpoint_url) == 0) {
      $endpoint_url = 'http://sandbox.bunchball.net/nitro/json';
--- 159,188 ----
  }
  
  /**
+  * Initialize the JavaScript on the page.
   */
  function _bunchball_nitro_initialize() {
+   global $user;
  
+   // Make sure javascript is only added once.
+   $nitro_js_url = "http://assets.bunchball.net/scripts/nitro/current/nitro.js";
    $current_js_array = drupal_add_js();
    if (isset ($current_js_array[$nitro_js_url])) {
      return;
    }
  
+   // Make sure API key is set.
    $api_key = variable_get('bunchball_apikey', '');
    if ($api_key == '') {
      watchdog('bunchball_nitro', 'API Key not set', array());
      return;
    }
  
+   // Detect whether the environment is production or debug (sandbox).
    $environment = variable_get('bunchball_environment', 'sandbox');
    $in_debug_mode = ($environment == 'sandbox');
  
+   // Parse domain from the variables.
    $endpoint_url = variable_get('bunchball_production_url', 'http://sandbox.bunchball.net/nitro/json');
    if (strlen($endpoint_url) == 0) {
      $endpoint_url = 'http://sandbox.bunchball.net/nitro/json';
***************
*** 198,204 ****
  
    $parsed_url = parse_url($endpoint_url);
  
-   // default value for the customer subdomain
    $customer_subdomain = 'sandbox';
    if (isset ($parsed_url['host'])) {
      $exploded_domain = explode(".", $parsed_url['host']);
--- 190,196 ----
  
    $parsed_url = parse_url($endpoint_url);
  
+   // Default value for the customer subdomain.
    $customer_subdomain = 'sandbox';
    if (isset ($parsed_url['host'])) {
      $exploded_domain = explode(".", $parsed_url['host']);
***************
*** 211,220 ****
      }
    }
  
-   // instantiate the variables for the JS
    $server_url = $in_debug_mode ?
-       'http://sandbox.bunchball.net/nitro/json' :
-       'http://' . $customer_subdomain . '.nitro.bunchball.net/nitro/json/';
    $user_id = $user->uid;
    $timestamp = time();
    $nitro = NitroAPI_Factory::getInstance();
--- 203,212 ----
      }
    }
  
+   // Instantiate the variables for the JS.
    $server_url = $in_debug_mode ?
+     'http://sandbox.bunchball.net/nitro/json' :
+     'http://' . $customer_subdomain . '.nitro.bunchball.net/nitro/json/';
    $user_id = $user->uid;
    $timestamp = time();
    $nitro = NitroAPI_Factory::getInstance();
***************
*** 224,234 ****
    // To include nitro.js, first put the following code into your HTML page as a
    // direct child of the <body> element or after the </body> tag.
    drupal_add_js($nitro_js_url, array(
-       'type' => 'external',
-       'weight' => -10,
-       'scope' => 'footer',
-       'group' => JS_LIBRARY,
-       'every_page' => TRUE,
    ));
  
    // Include settings for initializing the Nitro connection on the client side.
--- 216,226 ----
    // To include nitro.js, first put the following code into your HTML page as a
    // direct child of the <body> element or after the </body> tag.
    drupal_add_js($nitro_js_url, array(
+     'type' => 'external',
+     'weight' => -10,
+     'scope' => 'footer',
+     'group' => JS_LIBRARY,
+     'every_page' => TRUE,
    ));
  
    // Include settings for initializing the Nitro connection on the client side.
